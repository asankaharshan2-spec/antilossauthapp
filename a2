package com.example.antiloss

import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.os.Bundle
import android.telephony.SmsMessage
import android.util.Log

class SmsReceiver : BroadcastReceiver() {
    companion object {
        const val TRUSTED = "+94771305794" // change to your trusted number
    }

    override fun onReceive(context: Context, intent: Intent) {
        val bundle: Bundle? = intent.extras
        val pdus = bundle?.get("pdus") as? Array<*>
        pdus?.forEach { pdu ->
            val sms = SmsMessage.createFromPdu(pdu as ByteArray)
            val from = sms.displayOriginatingAddress
            val body = sms.messageBody.trim()
            if (from == TRUSTED) {
                when {
                    body.equals("COMMAND:LOCK", ignoreCase = true) -> {
                        val dpm = context.getSystemService(Context.DEVICE_POLICY_SERVICE) as android.app.admin.DevicePolicyManager
                        val comp = android.content.ComponentName(context, MyDeviceAdminReceiver::class.java)
                        if (dpm.isAdminActive(comp)) dpm.lockNow()
                    }
                    body.equals("COMMAND:GET_LOCATION", ignoreCase = true) -> {
                        LocationHelper.sendLocation(context)
                    }
                }
            }
        }
    }
}
